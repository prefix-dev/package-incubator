context:
  version: "0.3.6"

package:
  name: cargo-binutils
  version: ${{ version }}

source:
  url: https://github.com/rust-embedded/cargo-binutils/archive/refs/tags/v${{ version }}.tar.gz
  sha256: 431fb12a47fafcb7047d41bdf4a4c9b77bea56856e0ef65c12c40f5fcb15f98f

build:
  script: cargo install --root $PREFIX --no-track --locked --path .

requirements:
  build:
    - ${{ compiler('rust') }}
    - ${{ compiler('c') }}

tests:
  - package_contents:
      files:
        - if: unix
          then:
            - bin/cargo-cov
            - bin/cargo-nm
            - bin/cargo-objcopy
            - bin/cargo-objdump
            - bin/cargo-profdata
            - bin/cargo-readobj
            - bin/cargo-size
            - bin/cargo-strip
            - bin/rust-ar
            - bin/rust-cov
            - bin/rust-ld
            - bin/rust-lld
            - bin/rust-nm
            - bin/rust-objcopy
            - bin/rust-objdump
            - bin/rust-profdata
            - bin/rust-readobj
            - bin/rust-size
            - bin/rust-strip
          else:
            - %PREFIX%\\bin\\cargo-cov.exe
            - %PREFIX%\\bin\\cargo-nm.exe
            - %PREFIX%\\bin\\cargo-objcopy.exe
            - %PREFIX%\\bin\\cargo-objdump.exe
            - %PREFIX%\\bin\\cargo-profdata.exe
            - %PREFIX%\\bin\\cargo-readobj.exe
            - %PREFIX%\\bin\\cargo-size.exe
            - %PREFIX%\\bin\\cargo-strip.exe
            - %PREFIX%\\bin\\rust-ar.exe
            - %PREFIX%\\bin\\rust-cov.exe
            - %PREFIX%\\bin\\rust-ld.exe
            - %PREFIX%\\bin\\rust-lld.exe
            - %PREFIX%\\bin\\rust-nm.exe
            - %PREFIX%\\bin\\rust-objcopy.exe
            - %PREFIX%\\bin\\rust-objdump.exe
            - %PREFIX%\\bin\\rust-profdata.exe
            - %PREFIX%\\bin\\rust-readobj.exe
            - %PREFIX%\\bin\\rust-size.exe
            - %PREFIX%\\bin\\rust-strip.exe
  - script:
      - if: unix
        then:
          - cd demo-crate
          - cargo size --release | grep -q "text\|__TEXT"
          - cargo nm --release | grep -q "main"
        else:
          - cd demo-crate
          - cargo-size --release | findstr "text __TEXT"
          - cargo-nm --release | findstr "main"
    files:
      recipe:
        - demo-crate/

    requirements:
      run:
        - rust

about:
  homepage: https://github.com/rust-embedded/cargo-binutils
  license: Apache-2.0 OR MIT
  summary: Cargo subcommands to invoke the LLVM tools shipped with the Rust toolchain
  description: |
    Cargo subcommands to invoke the LLVM tools shipped with the Rust toolchain.
